<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>music</title>
		<link rel="stylesheet" href="../dist/static/bootstrap.min.css">
		<script
		  src="https://code.jquery.com/jquery-3.6.1.min.js"
		  integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
		  crossorigin="anonymous">
		</script>
		<style>
			#view, #files {
				margin: 30px;
			}
			
			.line {
				width: 0px;
				border: 1px solid;
				height: 100%;
				background-color: black;
				position: absolute;
				cursor: pointer
			}
			#wave{
				position: absolute;
				width: 100%;
				height: 100%;
				z-index:-2;
			}
			#waveContainer {
				height: 200px;
				width: 1000px;
			}
			#selectedArea {
				height: 100%;
				position: absolute;
				background-color: gray;
				width: inherit;
				margin-left: 2px;
				z-index:-1;
        opacity: 0.3;
			}
		</style>
	</head>
	<body>
		
    <input id="files" type="file" id="files" name="files[]" multiple />
    <div style="height: 200px;">
    	<div id="waveContainer" style="position: absolute">
	    	<canvas id="wave"></canvas>
	    	<div id="start" class="line"></div>
		    <div id="selectedArea"></div>
		    <div id="end" class="line" style="left: 100%"></div>
	    </div>
    </div>
    <button id="play">â–¶</button>
    <script>





function Complex(re, im) {
    this.re = re;
    this.im = im || 0.0;
}
Complex.prototype.add = function (other, dst) {
    dst.re = this.re + other.re;
    dst.im = this.im + other.im;
    return dst;
}
Complex.prototype.sub = function (other, dst) {
    dst.re = this.re - other.re;
    dst.im = this.im - other.im;
    return dst;
}
Complex.prototype.mul = function (other, dst) {
    //cache re in case dst === this
    var r = this.re * other.re - this.im * other.im;
    dst.im = this.re * other.im + this.im * other.re;
    dst.re = r;
    return dst;
}
Complex.prototype.cexp = function (dst) {
    var er = Math.exp(this.re);
    dst.re = er * Math.cos(this.im);
    dst.im = er * Math.sin(this.im);
    return dst;
}

Complex.prototype.magnitude = function () {
    return Math.sqrt(this.re * this.re + this.im * this.im);
}


const cfft = (amplitudes) => {
	var N = amplitudes.length;
	if (N <= 1)
		return amplitudes;

	var hN = N / 2;
	var even = [];
	var odd = [];
	even.length = hN;
	odd.length = hN;
	for (var i = 0; i < hN; ++i) {
		even[i] = amplitudes[i * 2];
		odd[i] = amplitudes[i * 2 + 1];
	}
	even = cfft(even);
	odd = cfft(odd);

	var a = -2 * Math.PI;
	for (var k = 0; k < hN; ++k) {
		if (!(even[k] instanceof Complex))
			even[k] = new Complex(even[k], 0);
		if (!(odd[k] instanceof Complex))
			odd[k] = new Complex(odd[k], 0);
		var p = k / N;
		var t = new Complex(0, a * p);
		t.cexp(t).mul(odd[k], t);
		amplitudes[k] = even[k].add(t, odd[k]);
		amplitudes[k + hN] = even[k].sub(t, even[k]);
	}
	return amplitudes;
}











window.AudioContext = window.AudioContext || window.webkitAudioContext;
var source;

function drawBuffer( width, height, context, buffer ) {
    var data = buffer.getChannelData( 0 );
    var step = Math.ceil( data.length / width );
    var amp = 600;
    for(var i=0; i < width; i++){
        var min = 1.0;
        var max = -1.0;
        for (var j=0; j<step; j++) {
            var datum = data[(i*step)+j]; 
            if (datum < min)
                min = datum;
            if (datum > max)
                max = datum;
        }
        context.fillRect(i,(1+min)*amp-500,1,Math.max(1,(max-min)*amp));
    }
}

const analysis = (data) => {
	const start = 0;
	const ret = [];
	for(let i = start; i < start+16384; i++) {
		ret.push(data[i]);
	}
	const temp = cfft(ret);
	for(const i in temp) {
		temp[i] = temp[i].magnitude();
	}
	console.info(temp);
}

let g_buf;
function playSound(arraybuffer) {
    var context = new window.AudioContext();
    context.decodeAudioData(arraybuffer, function (buf) {
        g_buf = buf;
        var canvas = document.getElementById("wave");
        drawBuffer( canvas.width, canvas.height, canvas.getContext('2d'), buf );
		analysis(buf.getChannelData( 0 ));
    });
}

function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object
    playFile(files[0]);
}

function playFile(file) {
    var freader = new FileReader();

    freader.onload = function (e) {
        console.log(e.target.result);
        playSound(e.target.result);
    };
    freader.readAsArrayBuffer(file);
}
document.getElementById('files').addEventListener('change', handleFileSelect, false);

$(".line").mousedown((e)=> {
	const left = e.clientX;
	const offset = e.target.parentElement.offsetLeft;
	$(e.target).css("left", left-offset);
	let movable = true;
	const line = $(e.target);
	$(window).mousemove((e)=> {
		if(movable===false)return;
		const startL = parseInt($("#start").css("left"));
		const endL = parseInt($("#end").css("left"));
		
		const leftLine = Math.min(startL, endL);
		const rightLine = Math.max(startL, endL);
		const leftMost = Math.min(e.clientX-offset, leftLine);
		line.css("left", e.clientX-offset);
		$("#selectedArea").css("left", leftMost);
		const selectedWidth = rightLine-leftLine;
		$("#selectedArea").css("width", selectedWidth);
	});
	$(window).mouseup((e)=> {
		movable = false;
	});
})

let analyser;
let tmp = 0;
let apart;
var render = function() {
    var dataArray = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(dataArray);

    let ret = [];
	for(let i in dataArray) {
		// if(i <= 20)continue;
		if(dataArray[i] > 140) {
			ret.push(i * apart);
		}
	}
	if(tmp === 12)console.info(dataArray);
	console.info(ret);
	tmp ++;
	if(tmp > 800)return;

    window.requestAnimationFrame(render);
}


let audioBufferSourceNode;
var start = function() {
	const startL = parseInt($("#start").css("left"));
	const endL = parseInt($("#end").css("left"));
	
	const leftLine = Math.min(startL, endL);
	const rightLine = Math.max(startL, endL);

  buffer = g_buf;
  if(audioBufferSourceNode) {
      audioBufferSourceNode.stop();
  }
  const audioContext = new AudioContext({
      sampleRate: 44100,
  });
  const l = leftLine*startL;
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 16384;
  apart = 44100 / analyser.fftSize;
  console.info(apart);
  
  audioBufferSourceNode = audioContext.createBufferSource();
  audioBufferSourceNode.connect(analyser);
  analyser.connect(audioContext.destination);
  audioBufferSourceNode.buffer = buffer;

  const total = $("#waveContainer").width();

  const start = audioBufferSourceNode.buffer.duration / total * leftLine;
  const length = audioBufferSourceNode.buffer.duration / total * (rightLine-leftLine);
  audioBufferSourceNode.start(audioContext.currentTime, start, length);
  window.requestAnimationFrame(render);
}











$("#play").click(() => {
    start();
});

		</script>
	</body>
</html>
