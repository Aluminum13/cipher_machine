<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>music</title>
		<link rel="stylesheet" href="../dist/static/bootstrap.min.css">
		<script
		  src="https://code.jquery.com/jquery-3.6.1.min.js"
		  integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
		  crossorigin="anonymous">
		</script>
		<style>
			#view, #files {
				margin: 30px;
			}
			
			.line {
				width: 0px;
				border: 1px solid;
				height: 100%;
				background-color: black;
				position: absolute;
				cursor: pointer
			}
			#wave{
				position: absolute;
				width: 100%;
				height: 100%;
				z-index:-2;
			}
			#waveContainer {
				height: 200px;
				width: 1000px;
			}
			#selectedArea {
				height: 100%;
				position: absolute;
				background-color: gray;
				width: inherit;
				margin-left: 2px;
				z-index:-1;
                opacity: 0.3;
			}
		</style>
	</head>
	<body>
		
    <input id="files" type="file" id="files" name="files[]" multiple />
    <div style="height: 200px;">
    	<div id="waveContainer" style="position: absolute">
	    	<canvas id="wave"></canvas>
	    	<div id="start" class="line"></div>
		    <div id="selectedArea"></div>
		    <div id="end" class="line" style="left: 100%"></div>
	    </div>
    </div>
    <button id="play">â–¶</button>
    <script>
window.AudioContext = window.AudioContext || window.webkitAudioContext;
var source;

function drawBuffer( width, height, context, buffer ) {
    var data = buffer.getChannelData( 0 );
    var step = Math.ceil( data.length / width );
    var amp = 600;
    for(var i=0; i < width; i++){
        var min = 1.0;
        var max = -1.0;
        for (var j=0; j<step; j++) {
            var datum = data[(i*step)+j]; 
            if (datum < min)
                min = datum;
            if (datum > max)
                max = datum;
        }
        context.fillRect(i,(1+min)*amp-500,1,Math.max(1,(max-min)*amp));
    }
}

let g_buf;
function playSound(arraybuffer) {
    var context = new window.AudioContext();
    context.decodeAudioData(arraybuffer, function (buf) {
        g_buf = buf;
        var canvas = document.getElementById("wave");
        drawBuffer( canvas.width, canvas.height, canvas.getContext('2d'), buf ); 
    });
}

function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object
    playFile(files[0]);
}

function playFile(file) {
    var freader = new FileReader();

    freader.onload = function (e) {
        console.log(e.target.result);
        playSound(e.target.result);
    };
    freader.readAsArrayBuffer(file);
}
document.getElementById('files').addEventListener('change', handleFileSelect, false);

$(".line").mousedown((e)=> {
	const left = e.clientX;
	const offset = e.target.parentElement.offsetLeft;
	$(e.target).css("left", left-offset);
	let movable = true;
	const line = $(e.target);
	$(window).mousemove((e)=> {
		if(movable===false)return;
		const startL = parseInt($("#start").css("left"));
		const endL = parseInt($("#end").css("left"));
		
		const leftLine = Math.min(startL, endL);
		const rightLine = Math.max(startL, endL);
		const leftMost = Math.min(e.clientX-offset, leftLine);
		line.css("left", e.clientX-offset);
		$("#selectedArea").css("left", leftMost);
		const selectedWidth = rightLine-leftLine;
		$("#selectedArea").css("width", selectedWidth);
	});
	$(window).mouseup((e)=> {
		movable = false;
	})
})


let audioBufferSourceNode;
var start = function() {
	const startL = parseInt($("#start").css("left"));
	const endL = parseInt($("#end").css("left"));
	
	const leftLine = Math.min(startL, endL);
	const rightLine = Math.max(startL, endL);

    buffer = g_buf;
    if(audioBufferSourceNode) {
        audioBufferSourceNode.stop();
    }
    const audioContext = new AudioContext({
        sampleRate: 44100,
    });
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    audioBufferSourceNode = audioContext.createBufferSource();
    audioBufferSourceNode.connect(analyser);
    analyser.connect(audioContext.destination);
    audioBufferSourceNode.buffer = buffer;

	const start = audioBufferSourceNode.buffer.duration / 1000 * leftLine;
	const length = audioBufferSourceNode.buffer.duration / 1000 * (rightLine-leftLine);
    audioBufferSourceNode.start(audioContext.currentTime, start, length);
}

$("#play").click(() => {
    start();
});

		</script>
	</body>
</html>
